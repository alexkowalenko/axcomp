#!/usr/bin/env python3
#
# AX compiler - lit helper
#

import os
import shutil
import subprocess
import sys
from pathlib import Path


def main() -> int:
    if len(sys.argv) < 4:
        print("usage: lit_run.py <tmp-dir> <tool> [tool args ...] <source>", file=sys.stderr)
        return 1

    tmp_dir = Path(sys.argv[1])
    tool_args = sys.argv[2:-1]
    source = Path(sys.argv[-1])

    tmp_dir.mkdir(parents=True, exist_ok=True)
    work_dir = tmp_dir / (source.stem or "test")
    work_dir.mkdir(parents=True, exist_ok=True)

    dst = work_dir / source.name
    shutil.copy2(source, dst)

    cmd = [*tool_args, str(dst)]
    result = subprocess.run(cmd, cwd=work_dir)
    return result.returncode


if __name__ == "__main__":
    sys.exit(main())
